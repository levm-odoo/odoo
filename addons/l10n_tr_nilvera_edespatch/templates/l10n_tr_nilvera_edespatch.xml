<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="nilvera_party_details"
        xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
        xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
        <cbc:WebsiteURI t-out="partner.website" />
        <cac:PartyIdentification>
            <t t-if="partner.country_id.code != 'TR'">
                <cbc:ID schemeID="TCKN" t-out="default_tckn"/>
            </t>
            <t t-else="">
                <cbc:ID t-att-schemeID="len(partner.vat) == 10 and 'VKN' or 'TCKN'" t-out="partner.vat"/>
            </t>
        </cac:PartyIdentification>
        <cac:PartyName>
            <cbc:Name t-out="partner.name"/>
        </cac:PartyName>
        <cac:PostalAddress>
            <cbc:StreetName t-out="partner.street"/>
            <cbc:CitySubdivisionName t-out="partner.city"/>
            <cbc:CityName t-out="partner.state_id.name"/>
            <cbc:PostalZone t-out="partner.zip"/>
            <cac:Country>
                <cbc:IdentificationCode t-out="partner.country_id.code"/>
                <cbc:Name t-out="countries.get(partner.country_id.code)"/>
            </cac:Country>
        </cac:PostalAddress>
        <cac:Contact>
            <cbc:Telephone t-out="partner.phone"/>
            <cbc:ElectronicMail t-out="partner.email"/>
        </cac:Contact>
    </template>

    <template id="nilvera_party_template"
        xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
        <cac:Party>
            <t t-call="l10n_tr_nilvera_edespatch.nilvera_party_details"/>
        </cac:Party>
    </template>

    <template id="nilvera_despatch_line"
        xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
        xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
        <cac:DespatchLine>
            <cbc:ID t-out="line.id"/>
            <cbc:DeliveredQuantity t-att-unitCode="line.product_id.uom_id.unspsc_code_id.code" t-out="line.quantity"/>
            <cac:OrderLineReference>
                <cbc:LineID t-out="line.id"/>
            </cac:OrderLineReference>
            <cac:Item>
                <cbc:Name t-out="line.product_id.name"/>
            </cac:Item>
        </cac:DespatchLine>
    </template>

    <template id="l10n_tr_edespatch_format" name="Turkiye e-Despatch XML">
        <DespatchAdvice xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:ds="http://www.w3.org/2000/09/xmldsig#"
            xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2"
            xmlns:xades="http://uri.etsi.org/01903/v1.3.2#"
            xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
            xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
            xmlns="urn:oasis:names:specification:ubl:schema:xsd:DespatchAdvice-2">
            <cbc:UBLVersionID t-out="ubl_version_id"/>
            <cbc:CustomizationID t-out="customization_id"/>
            <cbc:ProfileID t-out="picking.l10n_tr_nilvera_despatch_scenario"/>
            <cbc:ID t-out="'OUT'"/>
            <cbc:CopyIndicator t-out="copy_indicator"/>
            <cbc:UUID t-out="uuid"/>
            <cbc:IssueDate t-out="issue_date"/>
            <cbc:IssueTime t-out="issue_time"/>
            <cbc:DespatchAdviceTypeCode t-out="picking.l10n_tr_nilvera_despatch_type"/>
            <cbc:Note t-if="picking.l10n_tr_nilvera_delivery_notes" t-out="picking.l10n_tr_nilvera_delivery_notes"/>
            <cbc:LineCountNumeric t-out="line_count"/>
            <cac:AdditionalDocumentReference t-if="picking.l10n_tr_nilvera_despatch_type == 'MATBUDAN'">
                <cbc:ID t-out="picking.l10n_tr_nilvera_delivery_printed_number"/>
                <cbc:IssueDate t-out="picking.l10n_tr_nilvera_delivery_date"/>
                <cbc:DocumentType>MATBU</cbc:DocumentType>
            </cac:AdditionalDocumentReference>
            <cac:DespatchSupplierParty>
                <t t-call="l10n_tr_nilvera_edespatch.nilvera_party_template">
                    <t t-set="partner" t-value="current_company"/>
                </t>
            </cac:DespatchSupplierParty>
            <cac:DeliveryCustomerParty>
                <t t-call="l10n_tr_nilvera_edespatch.nilvera_party_template">
                    <t t-set="partner" t-value="picking.partner_id"/>
                </t>
            </cac:DeliveryCustomerParty>
            <cac:BuyerCustomerParty t-if="picking.l10n_tr_nilvera_buyer_id">
                <t t-call="l10n_tr_nilvera_edespatch.nilvera_party_template">
                    <t t-set="partner" t-value="picking.l10n_tr_nilvera_buyer_id"/>
                </t>
            </cac:BuyerCustomerParty>
            <cac:SellerSupplierParty t-if="picking.l10n_tr_nilvera_seller_supplier_id">
                <t t-call="l10n_tr_nilvera_edespatch.nilvera_party_template">
                    <t t-set="partner" t-value="picking.l10n_tr_nilvera_seller_supplier_id"/>
                </t>
            </cac:SellerSupplierParty>
            <cac:OriginatorCustomerParty t-if="picking.l10n_tr_nilvera_buyer_originator_id">
                <t t-call="l10n_tr_nilvera_edespatch.nilvera_party_template">
                    <t t-set="partner" t-value="picking.l10n_tr_nilvera_buyer_originator_id"/>
                </t>
            </cac:OriginatorCustomerParty>
            <cac:Shipment>
                <cbc:ID t-out="picking.id"/>
                <cac:GoodsItem>
                    <cbc:ValueAmount currencyID="TRY">0</cbc:ValueAmount>
                </cac:GoodsItem>
                <cac:ShipmentStage>
                    <cac:TransportMeans>
                        <cac:RoadTransport>
                            <cbc:LicensePlateID schemeID="PLAKA" t-out="picking.l10n_tr_vehicle_plate"/>
                        </cac:RoadTransport>
                    </cac:TransportMeans>
                    <t t-foreach="drivers" t-as="driver">    
                        <cac:DriverPerson>
                            <cbc:FirstName t-out="driver['name']"/>
                            <cbc:FamilyName t-out="driver['fname']"/>
                            <cbc:Title>Şoför</cbc:Title>
                            <cbc:NationalityID schemeID="TCKN" t-out="driver['tckn']"/>
                        </cac:DriverPerson>
                    </t>
                </cac:ShipmentStage>
                <cac:Delivery>
                    <cac:DeliveryAddress>
                        <cbc:StreetName t-out="picking.partner_id.street"/>
                        <cbc:CitySubdivisionName t-out="picking.partner_id.city"/>
                        <cbc:CityName t-out="picking.partner_id.state_id.name"/>
                        <cbc:PostalZone t-out="picking.partner_id.zip"/>
                        <cac:Country>
                            <cbc:IdentificationCode t-out="picking.partner_id.country_id.code"/>
                            <cbc:Name t-out="countries.get(picking.partner_id.country_id.code)"/>
                        </cac:Country>
                    </cac:DeliveryAddress>
                    <cac:CarrierParty t-if="picking.l10n_tr_nilvera_carrier_id">
                        <t t-call="l10n_tr_nilvera_edespatch.nilvera_party_details">
                            <t t-set="partner" t-value="picking.l10n_tr_nilvera_carrier_id"/>
                        </t>
                    </cac:CarrierParty>
                    <cac:Despatch>
                        <cbc:ActualDespatchDate t-out="actual_date"/>
                        <cbc:ActualDespatchTime t-out="actual_time"/>
                    </cac:Despatch>
                </cac:Delivery>
                <cac:TransportHandlingUnit>
                    <t t-foreach="picking.l10n_tr_nilvera_trailer_plate_ids" t-as="trailer">
                        <cac:TransportEquipment>
                            <cbc:ID schemeID="DORSEPLAKA" t-out="trailer.name"/>
                        </cac:TransportEquipment>
                    </t>
                </cac:TransportHandlingUnit>
            </cac:Shipment>
            <t t-foreach="picking.move_ids_without_package" t-as="line">
                <t t-call="l10n_tr_nilvera_edespatch.nilvera_despatch_line"/>
            </t>
        </DespatchAdvice>
    </template>

</odoo>
